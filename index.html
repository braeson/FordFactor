<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ford Factor</title>
    <style>
        /* VISUAL STYLING */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-green: #4caf50;
            --accent-red: #f44336;
            --accent-orange: #ff9800;
            --accent-blue: #2196F3;
            --link-color: #64b5f6;
            --border-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0 20px 40px 20px; /* Added bottom padding for scrolling */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { max-width: 800px; width: 100%; }

        header { text-align: center; margin-top: 40px; margin-bottom: 20px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { color: var(--text-muted); }

        /* SCOREBOARD - STICKY */
        .scoreboard-wrapper {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--bg-color);
            padding-top: 20px;
            padding-bottom: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .scoreboard {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            width: 100%;
            max-width: 600px;
            position: relative;
        }

        .total-label { font-size: 1rem; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        #total-amount {
            font-size: 4rem;
            font-weight: bold;
            margin: 0;
            line-height: 1;
        }

        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }

        /* SHARE BUTTON */
        .share-btn {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .share-btn:hover { transform: scale(1.05); background-color: #1976D2; }
        .share-btn:active { transform: scale(0.95); }
        .share-btn.copied { background-color: white; color: var(--bg-color); }

        /* Average Message */
        #average-msg {
            margin-top: 15px;
            background-color: #2a2a2a;
            border: 1px solid var(--accent-orange);
            color: var(--text-main);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none; 
        }

        /* INPUTS */
        .inputs-section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        .input-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: bold; color: var(--text-muted); font-size: 0.9rem; }
        input[type="number"] {
            background-color: #2c2c2c;
            border: 1px solid var(--border-color);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* SECTION HEADERS */
        .section-header {
            margin-bottom: 15px;
            margin-top: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        /* CARDS GRID */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
            user-select: none;
        }

        .card:hover { transform: translateY(-2px); border-color: var(--text-muted); }
        .card.selected { border-color: var(--accent-red); background-color: #2a1a1a; }
        .card.selected::after {
            content: "SELECTED";
            position: absolute;
            top: 10px; right: 10px;
            font-size: 0.7rem;
            background-color: var(--accent-red);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* MANDATORY CARDS */
        .card.mandatory {
            border-color: var(--accent-red);
            opacity: 0.95;
            cursor: default;
            background-color: #2a1a1a;
        }
        .card.mandatory:hover { transform: none; }
        .card.mandatory::after {
            content: "LOCKED";
            background-color: #444;
            color: #aaa;
        }

        /* TYPOGRAPHY IN CARDS */
        .card-title-link {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: var(--link-color);
            text-decoration: none;
            pointer-events: all; /* Ensure click passes through */
        }
        .card-title-link:hover { text-decoration: underline; }
        
        .card-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; line-height: 1.4; }
        .card-value { font-weight: bold; color: var(--accent-red); font-size: 1.1rem; }
        .card-multiplier { font-size: 0.8rem; color: var(--text-muted); font-weight: normal; margin-left: 5px;}

        @media (max-width: 600px) {
            .inputs-section { grid-template-columns: 1fr; }
            #total-amount { font-size: 3rem; }
            .scoreboard { padding: 15px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>The Ford Factor</h1>
        <p class="subtitle">Calculate the net impact of provincial policies on your wallet.</p>
    </header>

    <div class="scoreboard-wrapper">
        <div class="scoreboard">
            <div id="score-label" class="total-label">Doug Ford has saved you:</div>
            <div id="total-amount" class="positive">$0</div>
            
            <button id="share-btn" class="share-btn" onclick="copyResult()">
                Share Result
            </button>
        </div>
        
        <div id="average-msg">
            Good for you! But the average family is out <strong>$3,750</strong> per year.
        </div>
    </div>

    <div class="inputs-section">
        <div class="input-group">
            <label for="income">Annual Income ($)</label>
            <input type="number" id="income" value="55000" step="1000">
        </div>
        <div class="input-group">
            <label for="cars"># of Cars</label>
            <input type="number" id="cars" value="1" min="0">
        </div>
        <div class="input-group">
            <label for="children"># of Children</label>
            <input type="number" id="children" value="2" min="0">
        </div>
    </div>

    <h3 class="section-header">Select what applies to you:</h3>
    <div id="cards-container" class="cards-grid">
        <p style="color: red;">‚ö†Ô∏è Loading options... Ensure 'cards.js' is in the same folder.</p>
    </div>

    <h3 class="section-header">Taxpayer Waste (Everyone pays this)</h3>
    <div id="mandatory-container" class="cards-grid"></div>
</div>

<script src="cards.js"></script>

<script>
    // --- GLOBAL STATE ---
    let currentTotal = 0;
    const AVERAGE_LOSS_AMT = 3750; 

    // --- LOGIC ---
    const STICKER_SAVING = 120; 
    const GAS_TAX_SAVING_PER_CAR = 85; 

    const state = {
        income: 55000,
        cars: 1,
        children: 2,
        selectedIds: new Set()
    };

    const els = {
        income: document.getElementById('income'),
        cars: document.getElementById('cars'),
        children: document.getElementById('children'),
        total: document.getElementById('total-amount'),
        label: document.getElementById('score-label'),
        msg: document.getElementById('average-msg'),
        grid: document.getElementById('cards-container'),
        mandatoryGrid: document.getElementById('mandatory-container'),
        shareBtn: document.getElementById('share-btn')
    };

    function formatCurrency(num) {
        return '$' + num.toLocaleString('en-CA', {maximumFractionDigits: 0});
    }

    // Prevents card toggle when clicking the link
    window.openLink = function(e, url) {
        e.stopPropagation(); 
        window.open(url, '_blank');
    }

    function renderMandatory() {
        if (typeof mandatoryCards === 'undefined') return; 
        
        els.mandatoryGrid.innerHTML = '';
        mandatoryCards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card mandatory selected';
            div.innerHTML = `
                <a href="${card.url}" target="_blank" class="card-title-link">${card.title}</a>
                <div class="card-desc">${card.description}</div>
                <div class="card-value">-${formatCurrency(card.value)}</div>
            `;
            els.mandatoryGrid.appendChild(div);
        });
    }

    function renderOptions() {
        if (typeof cards === 'undefined') return; 

        els.grid.innerHTML = '';
        cards.forEach(card => {
            const div = document.createElement('div');
            const isSelected = state.selectedIds.has(card.id);
            div.className = `card ${isSelected ? 'selected' : ''}`;
            div.onclick = () => toggle(card.id);
            
            let valueText = `-${formatCurrency(card.value)}`;
            if (card.isPerChild) valueText += ` <span class="card-multiplier">per child</span>`;

            div.innerHTML = `
                <span class="card-title-link" onclick="openLink(event, '${card.url}')">${card.title} <span style="font-size:0.7em">üîó</span></span>
                <div class="card-desc">${card.description}</div>
                <div class="card-value">${valueText}</div>
            `;
            els.grid.appendChild(div);
        });
    }

    function calculateTotal() {
        if (typeof mandatoryCards === 'undefined' || typeof cards === 'undefined') return;

        // --- GAINS ---
        const generalTaxCut = state.income * 0.01;
        let liftCredit = 0;
        if (state.income < 50000) {
             if (state.income < 30000) liftCredit = 875; 
             else liftCredit = Math.round(875 * ((50000 - state.income) / 20000));
        }
        const carSavings = (state.cars * STICKER_SAVING) + (state.cars * GAS_TAX_SAVING_PER_CAR);
        let total = generalTaxCut + liftCredit + carSavings;

        // --- LOSSES ---
        mandatoryCards.forEach(c => total -= c.value);
        cards.forEach(card => {
            if (state.selectedIds.has(card.id)) {
                let cost = card.value;
                if (card.isPerChild) cost = cost * Math.max(1, state.children);
                total -= cost;
            }
        });

        currentTotal = total;

        // --- UPDATE UI ---
        const isNegative = total < 0;
        els.total.className = isNegative ? 'negative' : 'positive';
        els.total.innerText = (isNegative ? '-' : '+') + formatCurrency(Math.abs(total));

        // Update Label
        els.label.innerText = isNegative ? "Doug Ford cost you:" : "Doug Ford has saved you:";

        // Show/Hide Average Msg
        els.msg.style.display = isNegative ? 'none' : 'block';
    }

    function toggle(id) {
        if (state.selectedIds.has(id)) state.selectedIds.delete(id);
        else state.selectedIds.add(id);
        renderOptions();
        calculateTotal();
    }

    window.copyResult = function() {
        const link = window.location.href;
        let textToCopy = "";

        if (currentTotal < 0) {
            const cost = formatCurrency(Math.abs(currentTotal));
            textToCopy = `Doug Ford has cost my family ${cost} through his reckless spending and cuts to our province. Find out how much he's cost you: ${link}`;
        } else {
            const avgCost = formatCurrency(AVERAGE_LOSS_AMT);
            textToCopy = `Doug Ford has cost the average Ontario family ${avgCost} through his reckless spending and cuts to our province. Find out how much he's cost you: ${link}`;
        }

        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = els.shareBtn.innerText;
            els.shareBtn.innerText = "COPIED!";
            els.shareBtn.classList.add("copied");
            setTimeout(() => {
                els.shareBtn.innerText = originalText;
                els.shareBtn.classList.remove("copied");
            }, 2000);
        }).catch(err => {
            alert("Could not copy automatically. Please screenshot instead.");
        });
    }

    // Listeners
    els.income.addEventListener('input', (e) => { state.income = Number(e.target.value); calculateTotal(); });
    els.cars.addEventListener('input', (e) => { state.cars = Number(e.target.value); calculateTotal(); });
    
    // NEW LOGIC: Deselect child-based cards if children = 0
    els.children.addEventListener('input', (e) => { 
        state.children = Number(e.target.value);
        
        if (state.children === 0 && typeof cards !== 'undefined') {
            cards.forEach(card => {
                // If the card relies on kids and is selected, unselect it
                if (card.isPerChild && state.selectedIds.has(card.id)) {
                    state.selectedIds.delete(card.id);
                }
            });
            renderOptions(); // Re-render to show visual unselection
        }
        
        calculateTotal(); 
    });

    // Start
    window.addEventListener('load', () => {
        renderMandatory();
        renderOptions();
        calculateTotal();
    });

</script>
</body>
</html>